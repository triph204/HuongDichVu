# ??? Order Microservice - Architecture Overview

## ?? System Architecture

```
???????????????????????????????????????????????????????????????????????
?                        API Gateway / Load Balancer                  ?
???????????????????????????????????????????????????????????????????????
                                 ?
                    ???????????????????????????
                    ?                         ?
            ????????????????????      ?????????????????
            ?   WebClient      ?      ?   WebAdmin    ?
            ?  (React/Vue)     ?      ?  (ASP.NET)    ?
            ????????????????????      ?????????????????
                     ?                        ?
                     ??????????????????????????
                                  ?
                  ??????????????????????????????????
                  ?                                ?
         ?????????????????????????????   ???????????????????
         ?  Order Microservice API   ?   ?   Old Backend   ?
         ?        (Port: 5001)       ?   ?  (Deprecated)   ?
         ?????????????????????????????   ??????????????????
                  ?
       ???????????????????????
       ?          ?          ?
    ???????   ??????????   ???????
    ?HTTP ?   ?SignalR ?   ?REST ?
    ???????   ??????????   ???????
       ?          ?           ?
       ????????????????????????
                  ?
    ?????????????????????????????
    ?  Order Microservice Core  ?
    ?????????????????????????????
    ? • Controllers             ?
    ? • Services                ?
    ? • Repositories            ?
    ? • Domain Models           ?
    ?????????????????????????????
                  ?
    ??????????????????????????????
    ?  SQL Server Database       ?
    ??????????????????????????????
    ? • Orders Table             ?
    ? • OrderDetails Table       ?
    ? • Indexes & Relations      ?
    ??????????????????????????????
```

---

## ?? Layered Architecture

```
?????????????????????????????????????????????????????????
?                    API Layer                          ?
?  ?? Controllers (HTTP endpoints)                      ?
?  ?? Filters (Authentication, Validation)              ?
?  ?? Middleware (Error handling, Logging)              ?
?  ?? SignalR Hubs (Real-time updates)                  ?
?????????????????????????????????????????????????????????
?                Application Layer                      ?
?  ?? DTOs (Data Transfer Objects)                      ?
?  ?? Services (Business logic)                         ?
?  ?? Validators (Input validation)                     ?
?  ?? Mapping (DTO ? Domain Entity)                     ?
?????????????????????????????????????????????????????????
?                  Domain Layer                         ?
?  ?? Entities (Order, OrderDetail)                     ?
?  ?? Value Objects                                     ?
?  ?? Constants (Status values)                         ?
?  ?? Interfaces                                        ?
?????????????????????????????????????????????????????????
?             Infrastructure Layer                      ?
?  ?? DbContext (EF Core)                               ?
?  ?? Repositories (Data access)                        ?
?  ?? Migrations (Schema changes)                       ?
?  ?? Seeds (Initial data)                              ?
?????????????????????????????????????????????????????????
```

---

## ?? Project Structure

```
OrderMicroservice/
??? Order.API/                          # API Project
?   ??? Program.cs                      # Configuration & startup
?   ??? Controllers/                    # HTTP endpoints
?   ?   ??? OrdersController.cs         # Order CRUD operations
?   ?   ??? OrderDetailsController.cs   # Order details operations
?   ?   ??? HealthController.cs         # Health check endpoints
?   ??? Hubs/
?   ?   ??? OrderHub.cs                 # SignalR hub for real-time updates
?   ??? Middleware/
?   ?   ??? GlobalExceptionMiddleware.cs # Global error handling
?   ??? Models/
?   ?   ??? ResponseModels.cs           # API response DTOs
?   ??? appsettings.json
?   ??? appsettings.Development.json
?   ??? Dockerfile
?
??? Order.Domain/                       # Domain Project
?   ??? Entities/
?   ?   ??? OrderEntity.cs              # Order domain entity
?   ?   ??? OrderDetailEntity.cs        # OrderDetail domain entity
?   ??? Constants/
?       ??? OrderStatus.cs              # Order status constants
?
??? Order.Infrastructure/               # Infrastructure Project
?   ??? Data/
?   ?   ??? OrderDbContext.cs           # Entity Framework DbContext
?   ??? Repositories/
?   ?   ??? IOrderRepository.cs         # Order repository interface
?   ?   ??? OrderRepository.cs          # Order repository implementation
?   ?   ??? IOrderDetailRepository.cs   # OrderDetail repository interface
?   ?   ??? OrderDetailRepository.cs    # OrderDetail repository implementation
?   ??? Migrations/
?   ?   ??? 20240101000000_InitialCreate.cs
?   ?   ??? OrderDbContextModelSnapshot.cs
?   ?   ??? MigrationHelper.cs
?   ?   ??? DatabaseSeeder.cs           # Initial data seeding
?   ??? Seeds/
?       ??? DatabaseSeeder.cs           # Test data
?
??? Order.Application/                  # Application Project
?   ??? DTOs/
?   ?   ??? OrderDtos.cs                # Order request/response DTOs
?   ?   ??? OrderDetailDtos.cs          # OrderDetail DTOs
?   ??? Services/
?       ??? IOrderService.cs            # Order service interface
?       ??? OrderService.cs             # Order business logic
?       ??? IOrderDetailService.cs      # OrderDetail service interface
?       ??? OrderDetailService.cs       # OrderDetail business logic
?
??? Order.Tests/                        # Test Project
?   ??? Services/
?       ??? OrderServiceTests.cs        # Unit tests
?
??? OrderMicroservice.sln               # Solution file
??? docker-compose.yml                  # Docker composition
??? .gitignore
??? README.md
??? QUICK_START.md
??? API_DOCUMENTATION.md
??? INTEGRATION_GUIDE.md
??? ARCHITECTURE.md                     # This file
??? ENVIRONMENT.md
```

---

## ?? Request/Response Flow

### Create Order Flow
```
Client
  ?
  ??? POST /api/orders
  ?
API Layer
  ??? OrdersController.Create()
  ??? Validate request
  ?
Application Layer
  ??? OrderService.CreateOrderAsync()
  ??? Map DTO to Entity
  ?
Infrastructure Layer
  ??? OrderRepository.CreateAsync()
  ??? SaveChanges()
  ?
Database
  ??? Insert Order record
  ??? Insert OrderDetail records
  ?
Response
  ??? 201 Created
  ??? OrderDto with generated OrderId
```

### SignalR Broadcast Flow
```
OrderService.CreateOrderAsync()
  ?
  ??? Save to database
  ?
  ??? OrderHub.SendNewOrder()
  ?
SignalR Hub
  ??? Broadcast to all connected clients
  ?
Clients
  ??? Receive "ReceiveNewOrder" event
  ??? Update UI
  ??? Display new order
```

---

## ?? Database Schema

### Orders Table
```sql
CREATE TABLE Orders (
    Id INT PRIMARY KEY IDENTITY(1,1),
    OrderNumber NVARCHAR(50) NOT NULL,
    TableId INT NOT NULL,
    TableName NVARCHAR(50) NOT NULL,
    TotalAmount DECIMAL(10,2) NOT NULL,
    Status NVARCHAR(50) NOT NULL,
    CustomerNote NVARCHAR(500),
    CreatedAt DATETIME2 NOT NULL,
    UpdatedAt DATETIME2,
    CompletedAt DATETIME2
);
```

### OrderDetails Table
```sql
CREATE TABLE OrderDetails (
    Id INT PRIMARY KEY IDENTITY(1,1),
    OrderId INT NOT NULL,
    DishId INT NOT NULL,
    DishName NVARCHAR(200) NOT NULL,
    Quantity INT NOT NULL,
    UnitPrice DECIMAL(10,2) NOT NULL,
    TotalPrice DECIMAL(10,2) NOT NULL,
    DishNote NVARCHAR(300),
    FOREIGN KEY (OrderId) REFERENCES Orders(Id) ON DELETE CASCADE
);
```

### Relationships
```
Orders (1) ??? (Many) OrderDetails
  ?? One order can have many dishes
  ?? Cascade delete enabled
```

---

## ?? Security Considerations

### Current Implementation
- ? CORS configured (AllowAll for development)
- ? Global exception handling
- ? Input validation in DTOs
- ? SQL injection protected (EF Core parameterized queries)

### To-Do (Production)
- [ ] Add JWT authentication
- [ ] Add role-based authorization
- [ ] Implement rate limiting
- [ ] Add request/response logging
- [ ] Implement request signing
- [ ] Add API versioning

---

## ? Performance Optimization

### Current Implementation
- ? Async/await operations
- ? Connection pooling (EF Core)
- ? Index on foreign keys
- ? Eager loading with .Include()

### Recommendations
- [ ] Add caching layer (Redis)
- [ ] Implement pagination
- [ ] Add database query optimization
- [ ] Use read replicas for heavy queries
- [ ] Implement CQRS for read/write separation

---

## ?? Deployment Topology

### Development
```
Localhost:5001 ? SQL Server LocalDB/Express
```

### Docker Compose
```
Order API Container ? SQL Server Container ? Docker Network
```

### Kubernetes
```
????????????????????????????????????????????????
?         Kubernetes Cluster                    ?
????????????????????????????????????????????????
? Pod                                           ?
?  ?? Order Microservice Container             ?
?     ?? App running on 8080                   ?
????????????????????????????????????????????????
? Service                                      ?
?  ?? ClusterIP:5001 ? Pod:8080                ?
????????????????????????????????????????????????
? Persistent Volume                            ?
?  ?? SQL Server Data Storage                  ?
????????????????????????????????????????????????
```

---

## ?? Scalability Strategy

### Horizontal Scaling
```
Load Balancer
    ??? Order API Instance 1
    ??? Order API Instance 2
    ??? Order API Instance 3
         ?
    Shared Database (SQL Server)
```

### Database Scaling
```
Write Database (Primary)
         ?
    ???????????
    ?         ?
Read DB 1   Read DB 2  (Replicas)
```

---

## ?? Technology Stack

| Layer | Technology |
|-------|-----------|
| Framework | .NET 10.0 |
| Language | C# 13 |
| API | ASP.NET Core 10 |
| Real-time | SignalR |
| ORM | Entity Framework Core 8 |
| Database | SQL Server 2022 |
| Containerization | Docker, Docker Compose |
| Testing | xUnit, Moq |
| API Docs | Swagger/OpenAPI |

---

## ?? Monitoring & Logging

### Logging
- Structured logging dengan ILogger
- Log levels: Debug, Information, Warning, Error, Critical
- Correlation IDs for request tracing

### Monitoring
- Health check endpoints
- Kubernetes probes (liveness, readiness)
- Application Insights (optional)
- Custom metrics

### Alerts
- High error rate
- Slow response times
- Database connectivity issues

---

## ?? Integration Points

### With Old Backend
```
WebClient ? Order Microservice API (new)
           ? Old Backend API (deprecated)
```

### With Admin Panel
```
WebAdmin ? Order Microservice API
         ? SignalR for real-time updates
```

### Event Broadcasting
```
Order Service ? SignalR Hub ? All Connected Clients
```

---

## ?? Code Examples

### Repository Pattern
```csharp
// Interface
public interface IOrderRepository
{
    Task<OrderEntity> CreateAsync(OrderEntity order);
    Task<OrderEntity?> GetByIdAsync(int id);
}

// Implementation
public class OrderRepository : IOrderRepository
{
    private readonly OrderDbContext _context;
    
    public async Task<OrderEntity> CreateAsync(OrderEntity order)
    {
        _context.Orders.Add(order);
        await _context.SaveChangesAsync();
        return order;
    }
}
```

### Service Pattern
```csharp
public class OrderService : IOrderService
{
    private readonly IOrderRepository _repo;
    
    public async Task<OrderDto> CreateOrderAsync(CreateOrderDto dto)
    {
        // Business logic here
        var entity = new OrderEntity { ... };
        var created = await _repo.CreateAsync(entity);
        return MapToDto(created);
    }
}
```

---

## ? Best Practices Implemented

- ? SOLID Principles
- ? Repository Pattern
- ? Dependency Injection
- ? Async/Await
- ? Error Handling
- ? Logging
- ? DTO Mapping
- ? Unit Testing
- ? API Documentation
- ? Clean Architecture

---

## ?? Future Enhancements

- [ ] Order status notifications via Email/SMS
- [ ] Order analytics dashboard
- [ ] Advanced filtering & search
- [ ] Order history & audit trail
- [ ] Payment integration
- [ ] Inventory management integration
- [ ] Multi-language support
- [ ] Mobile API optimization

---

**Document Version:** 1.0.0  
**Last Updated:** 2024-01-01
