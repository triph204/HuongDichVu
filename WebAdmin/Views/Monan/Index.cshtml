@model PaginatedList<MonAnViewModel>
@{
    ViewData["Title"] = "Qu·∫£n L√Ω M√≥n ƒÇn";
    var danhMucList = ViewData["DanhMucList"] as List<DanhMucViewModel> ?? new List<DanhMucViewModel>();
    var currentCategory = (int)(ViewData["CurrentCategory"] ?? 0);
}

<div class="card">
    <div class="card-header d-flex justify-between align-center">
        <h2>üç¥ Danh S√°ch M√≥n ƒÇn</h2>
        <a href="/MonAn/Create" class="btn btn-secondary">+ Th√™m M√≥n</a>
    </div>

    <!-- ‚úÖ FILTER THEO DANH M·ª§C -->
    <div class="card-body">
        <div class="filter-section mb-20">
            <form method="get" action="/MonAn" class="d-flex gap-10 align-center">
                <label for="categoryFilter" style="font-weight: 600; white-space: nowrap;">
                    <i class="fas fa-filter"></i> L·ªçc theo danh m·ª•c:
                </label>
                <select id="categoryFilter" name="categoryId" class="form-control" style="max-width: 300px;" onchange="this.form.submit()">
                    @if (currentCategory == 0)
                    {
                        <option value="0" selected>-- T·∫•t c·∫£ danh m·ª•c --</option>
                    }
                    else
                    {
                        <option value="0">-- T·∫•t c·∫£ danh m·ª•c --</option>
                    }
                    
                    @foreach (var dm in danhMucList)
                    {
                        @if (currentCategory == dm.DanhMucId)
                        {
                            <option value="@dm.DanhMucId" selected>@dm.TenDanhMuc</option>
                        }
                        else
                        {
                            <option value="@dm.DanhMucId">@dm.TenDanhMuc</option>
                        }
                    }
                </select>
                
                @if (currentCategory > 0)
                {
                    <a href="/MonAn" class="btn btn-light btn-sm">
                        <i class="fas fa-times"></i> X√≥a l·ªçc
                    </a>
                }
            </form>
        </div>

        <!-- ‚úÖ TH√îNG TIN PH√ÇN TRANG -->
        <div class="mb-20" style="color: #666;">
            Hi·ªÉn th·ªã <strong>@Model.Items.Count</strong> trong t·ªïng s·ªë <strong>@Model.TotalCount</strong> m√≥n ƒÉn
            @if (currentCategory > 0)
            {
                var categoryName = danhMucList.FirstOrDefault(d => d.DanhMucId == currentCategory)?.TenDanhMuc;
                <span> - Danh m·ª•c: <strong>@categoryName</strong></span>
            }
        </div>

        <!-- ‚úÖ B·∫¢NG M√ìN ƒÇN -->
        @if (Model.Items.Any())
        {
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>T√™n M√≥n</th>
                            <th>Danh M·ª•c</th>
                            <th>Gi√°</th>
                            <th>C√≥ S·∫µn</th>
                            <th>H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Items)
                        {
                            <tr>
                                <td>@item.TenMon</td>
                                <td>@(item.TenDanhMuc)</td>
                                <td>@item.Gia.ToString("N0")ƒë</td>
                                <td>
                                    <span class="badge @(item.CoSan ? "badge-success" : "badge-danger")">
                                        @(item.CoSan ? "‚úì C√≥" : "‚úó H·∫øt")
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="/MonAn/Edit/@item.MonId" class="btn btn-primary btn-sm">S·ª≠a</a>
                                        <a href="/MonAn/Delete/@item.MonId" class="btn btn-danger btn-sm" 
                                           onclick="return confirm('X√°c nh·∫≠n x√≥a m√≥n @item.TenMon?')">X√≥a</a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- ‚úÖ PH√ÇN TRANG TH√îNG MINH -->
            @if (Model.TotalPages > 1)
            {
                <div class="pagination-container mt-20">
                    <ul class="pagination">
                        <!-- ‚úÖ Previous - CH·ªà hi·ªÉn th·ªã n·∫øu c√≥ trang tr∆∞·ªõc -->
                        @if (Model.HasPreviousPage)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=@(Model.PageIndex - 1)&categoryId=@currentCategory">
                                    <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
                                </a>
                            </li>
                        }

                        @{
                            // T√≠nh to√°n ph·∫°m vi trang hi·ªÉn th·ªã (hi·ªÉn th·ªã 5 trang: 2 tr∆∞·ªõc + hi·ªán t·∫°i + 2 sau)
                            int startPage = Math.Max(1, Model.PageIndex - 2);
                            int endPage = Math.Min(Model.TotalPages, Model.PageIndex + 2);
                            
                            // ƒêi·ªÅu ch·ªânh ƒë·ªÉ lu√¥n hi·ªÉn th·ªã 5 trang n·∫øu c√≥ th·ªÉ
                            if (endPage - startPage < 4)
                            {
                                if (startPage == 1)
                                {
                                    endPage = Math.Min(Model.TotalPages, startPage + 4);
                                }
                                else if (endPage == Model.TotalPages)
                                {
                                    startPage = Math.Max(1, endPage - 4);
                                }
                            }
                        }

                        <!-- ‚úÖ Trang ƒë·∫ßu + d·∫•u ... n·∫øu c·∫ßn -->
                        @if (startPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=1&categoryId=@currentCategory">1</a>
                            </li>
                            @if (startPage > 2)
                            {
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            }
                        }

                        <!-- ‚úÖ C√°c trang trong ph·∫°m vi -->
                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                                <a class="page-link" href="?page=@i&categoryId=@currentCategory">@i</a>
                            </li>
                        }

                        <!-- ‚úÖ D·∫•u ... + trang cu·ªëi n·∫øu c·∫ßn -->
                        @if (endPage < Model.TotalPages)
                        {
                            @if (endPage < Model.TotalPages - 1)
                            {
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            }
                            <li class="page-item">
                                <a class="page-link" href="?page=@Model.TotalPages&categoryId=@currentCategory">@Model.TotalPages</a>
                            </li>
                        }

                        <!-- ‚úÖ Next - CH·ªà hi·ªÉn th·ªã n·∫øu c√≥ trang sau -->
                        @if (Model.HasNextPage)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?page=@(Model.PageIndex + 1)&categoryId=@currentCategory">
                                    Sau <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            }
        }
        else
        {
            <div class="no-data">
                <p>
                    @if (currentCategory > 0)
                    {
                        <text>Kh√¥ng c√≥ m√≥n ƒÉn n√†o trong danh m·ª•c n√†y</text>
                    }
                    else
                    {
                        <text>Ch∆∞a c√≥ m√≥n ƒÉn n√†o</text>
                    }
                </p>
            </div>
        }
    </div>
</div>